name: Build Linux ARM AppImage

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ main ]

jobs:
  build-linux-arm:
    runs-on: ubuntu-24.04-arm  # 官方 ARM runner（确认可用）

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            libgtk-3-dev \
            libx11-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libdrm-dev \
            libgbm-dev \
            libasound2-dev \
            fuse \
            desktop-file-utils \
            libappindicator3-dev \
            wget \
            curl \
            git \
            unzip

      - name: Set up Flutter from Git
        run: |
          git clone https://github.com/flutter/flutter.git -b 3.38.3 --depth 1 ~/flutter
          echo "$HOME/flutter/bin" >> $GITHUB_PATH

      - name: Verify Flutter
        run: flutter --version

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Install Dart & Flutter dependencies
        run: flutter pub get

      - name: Build Linux ARM release
        run: flutter build linux --release

      - name: Install appimagetool
        run: |
          mkdir -p ~/bin
          cd ~/bin
          wget -c "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage"
          chmod +x appimagetool-aarch64.AppImage
          ./appimagetool-aarch64.AppImage --appimage-extract
          echo "$HOME/bin/squashfs-root/usr/bin" >> $GITHUB_PATH

      - name: Run flutter_distributor to generate AppImage
        run: |
          dart pub global activate flutter_distributor
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          flutter_distributor build --targets=linux-appimage

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-Linux-ARM64.AppImage
          path: build/distributor/linux-appimage/*.AppImage