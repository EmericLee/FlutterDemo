name: All Platform Build

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ main ]

jobs:
  # ---------------------------------------------------
  # 1. Android 构建任务
  # ---------------------------------------------------
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.5' # 对应 Dart 3.0.5
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # ---------------------------------------------------
  # 2. Windows 构建任务
  # ---------------------------------------------------
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.5'
          channel: 'stable'
          cache: true
          
      - name: Enable Desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      # 压缩产物以便上传
      - name: Compress Build
        run: Compress-Archive -Path build\windows\runner\Release\* -DestinationPath windows-release.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-windows
          path: windows-release.zip

  # ---------------------------------------------------
  # 3. Linux ARM64 构建任务 (最难的部分)
  # ---------------------------------------------------
  build-linux-arm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 1. 设置 QEMU 模拟器以支持 ARM 架构
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      # 2. 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 使用 Docker 在容器内交叉编译 Linux ARM 版本
      # 注意：这里我们需要创建一个 Dockerfile 来定义构建环境
      - name: Create Dockerfile for Build
        run: |
          cat <<EOF > Dockerfile.arm
          FROM ghcr.io/cirruslabs/flutter:3.10.5
          
          # 安装 Linux 编译依赖
          RUN sudo apt-get update && sudo apt-get install -y \
              clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          
          WORKDIR /app
          COPY . .
          
          # 解决安全目录问题
          RUN git config --global --add safe.directory /app
          
          # 获取依赖并构建
          RUN flutter config --enable-linux-desktop
          RUN flutter pub get
          RUN flutter build linux --release --target-platform=linux-arm64
          EOF

      # 4. 执行构建 (注意平台指定为 linux/arm64)
      - name: Build inside Docker
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -f Dockerfile.arm \
            -t my-flutter-app-arm \
            --output type=local,dest=output/ \
            .

      # 5. 打包并上传
      - name: Compress Linux ARM Build
        run: |
          cd output/build/linux/arm64/release/bundle
          tar -czvf ../../../../../../linux-arm64.tar.gz .

      - name: Upload Linux ARM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-linux-arm64
          path: linux-arm64.tar.gz
