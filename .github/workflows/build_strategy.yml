name: "Build All"

on:
  push:
    tags:libstdc
      - "vb*.*.*"  # 当推送v开头的标签时触发CI/CD
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  build:
    permissions:
      contents: write  # 允许上传发布文件
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "ubuntu-latest"
            target: "linux-arm64"
            arch: "arm64"
          - platform: "windows-latest"
            target: "windows-x86"
            arch: "x86"
          - platform: "ubuntu-latest"
            target: "android"
            arch: "arm64"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      # ====================================================
      # Flutter 环境配置
      # ====================================================
      - name: 配置 Flutter
        uses: subosito/flutter-action@v2
        with:
          # flutter-version: '3.10.0'  # 指定Flutter版本
          channel: 'stable'          # 使用stable通道

      - name: 获取依赖
        run: |
          flutter pub get
          flutter clean

      # ====================================================
      # Linux 构建 (ARM64)
      # ====================================================
      - name: 安装 Linux 依赖 (ARM64)
        if: matrix.target == 'linux-arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          # 安装 ARM64 交叉编译工具链
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: 构建 Linux ARM64
        if: matrix.target == 'linux-arm64'
        run: |
          # 启用 Linux 桌面支持
          flutter config --enable-linux-desktop
          # 构建 Linux ARM64 发布版本
          flutter build linux --release --target-platform linux-arm64

      - name: 打包 Linux ARM64 产物
        if: matrix.target == 'linux-arm64'
        run: |
          mkdir -p linux-release
          cp -r build/linux/arm64/release/bundle/* linux-release/
          tar -czf flutter_demo-linux-arm64.tar.gz linux-release/

      # ====================================================
      # Windows 构建 (x86)
      # ====================================================
      - name: 安装 Windows 依赖 (x86)
        if: matrix.target == 'windows-x86'
        run: |
          # 在 Windows 上安装必要的构建工具
          vcpkg install gtk:x86-windows

      - name: 构建 Windows x86
        if: matrix.target == 'windows-x86'
        run: |
          # 启用 Windows 桌面支持
          flutter config --enable-windows-desktop
          # 构建 Windows x86 发布版本
          flutter build windows --release --target-platform windows-x86

      - name: 打包 Windows x86 产物
        if: matrix.target == 'windows-x86'
        run: |
          Compress-Archive -Path build\windows\runner\Release\* -DestinationPath flutter_demo-windows-x86.zip

      # ====================================================
      # Android 构建
      # ====================================================
      - name: 设置 Java (Android)
        if: matrix.target == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: 设置 Android SDK
        if: matrix.target == 'android'
        uses: android-actions/setup-android@v3

      - name: 配置 Android 签名
        if: matrix.target == 'android' && env.ANDROID_KEYSTORE_BASE64 != ''
        run: |
          # 恢复签名密钥
          mkdir -p ~/.android
          echo ${{ secrets.ANDROID_KEYSTORE_BASE64 }} | base64 -d > ~/.android/release.keystore
          # 创建签名配置文件
          echo "storeFile=~/.android/release.keystore" > android/key.properties
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 || '' }}

      - name: 构建 Android
        if: matrix.target == 'android'
        run: |
          # 启用 Android 支持
          flutter config --enable-android
          # 构建 Android 发布版本
          flutter build apk --release --target-platform android-arm64

      # ====================================================
      # 上传构建产物到 GitHub Release
      # ====================================================
      - name: 上传 Linux ARM64 产物
        if: matrix.target == 'linux-arm64'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          generate_release_notes: true
          files: flutter_demo-linux-arm64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传 Windows x86 产物
        if: matrix.target == 'windows-x86'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          generate_release_notes: true
          files: flutter_demo-windows-x86.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传 Android 产物
        if: matrix.target == 'android'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          generate_release_notes: true
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}